
@model BulkUpdate
<link href="https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
      rel="stylesheet">
<h4>Bulk Config Mass Updater</h4>
<hr />
<script type="text/javascript">
    function OnlyNumeric(e) {
        if ((e.which < 48 || e.which > 57)) {
            if (e.which == 8 || e.which == 46 || e.which == 0)
                return true;
            else return e.which;
        }
    }
    function updateui() {
        document.getElementById('Submit').value = 'Running CONFIG IMPORT..';
        document.getElementById('spin').style.visibility = "visible";
        document.getElementById('divAlert').style.visibility = "visible";
        document.getElementById("divAlert").children[0].innerHTML = "Running ...";

        document.getElementById('UploadBtn').value = 'Running CONFIG IMPORT..';

    }

</script>


@using (Html.BeginForm("ImportExcelFile", "Home", FormMethod.Post))
{
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <div style="width:70%">
        <table class="table table-striped">



            <tr>
                <td>@Html.LabelFor(model => model.ThrottleNum)</td>
                <td>

                    @Html.EditorFor(model => model.ThrottleNum, new
                   {
                       htmlAttributes = new
                       {
                           @type = "number",
                            @min = "0",
                            @max = "100",
                            @step = "1",
                           @onkeypress = "OnlyNumeric(this);",
                            Class = "form-control"
                       }
                   })
                    <input type="hidden" id="txtEnvironment" value="@TempData.Peek("Environment")" />
                    <input type="hidden" id="txtUserID" value="@TempData.Peek("Userid")" />
                </td>
                <td style="color:red;font: all-petite-caps;font-weight:bold;">@Html.ValidationMessageFor(model => model.ThrottleNum)</td>
            </tr>

            <tr>
                <td>@Html.LabelFor(model => model.ThrottleDuration)</td>
                <td>
                    @Html.EditorFor(model => model.ThrottleDuration, new
                    {
                        htmlAttributes = new
                        {
                            @type = "number",
                            @min = "0",
                            @max = "100",
                            @step = "1",
                            @onkeypress = "OnlyNumeric(this);",
                            Class = "form-control"
                        }
                    })
                </td>
                <td style="color:red;font: all-petite-caps;font-weight:bold">@Html.ValidationMessageFor(model => model.ThrottleDuration)</td>
            </tr>

            <tr>
                <td>
                    @Html.LabelFor(model => model.RTU)
                </td>
                <td colspan="2">
                    @Html.CheckBoxFor(model => model.RTU)
                </td>
            </tr>
            <tr>
                <td>
                    @Html.HiddenFor(model => model.FileName)Select File:
                </td>
                <td colspan="2">
                    <input type="file" model onchange="document.getElementById('FileName').value = this.value;" name="file1" id="file1" value="s" />
                </td>

            </tr>

            <tr>
                <td colspan="3">
                    <span style="color:green">@Html.Raw(ViewBag.Message)</span>
                    <button name="button" runat="server" class="btn btn-success" id="btnRun" value="cph" asp-action="check">Run</button>
                    <input id="Submit" class="btn btn-success" type="submit" value="Run BULK CONFIG IMPORT" disabled onclick="updateui() " />
                    &nbsp;&nbsp;&nbsp;
                    <input type="button" id="UploadBtn" class="btn btn-danger" value="Run CONFIG IMPORT   " disabled onclick="updateui()" />
                    <div id="spin" class="spinner-border" role="status" style="visibility:hidden">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <br /><br />

                    <div id="divAlert" runat="server" class="alert alert-success alert-dismissible  fade show" style="visibility:hidden" role="alert">
                        <strong>&nbsp;@TempData["Status"]</strong>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    @*<div id="divProcessed1">
                            <strong>Total Rows::::</strong>
                            @Html.LabelFor(model => model.TotalRows, "Rows to process", new { Class = "form-label" })
                        </div>*@
                    <div id="progress" style="display:none">
                        <div class="progress" id="uu">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                 aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%">
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>



}

@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

@section scripts{
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script>

        $('#UploadBtn').click(function () {
            var userid = document.getElementById("txtUserID").value;
            var conn = document.getElementById("txtEnvironment").value;
            var throttlenum = document.getElementById("ThrottleNum").value;
            var throttleduration = document.getElementById("ThrottleDuration").value;
            var rtu = document.getElementById("RTU").checked;
            var fullPath = document.getElementById("FileName").value;
            var filename = fullPath.replace(/^.*[\\\/]/, '');
          
            console.log(conn + '---' + userid + "---" + throttlenum + "--" + throttleduration + "--" + rtu + "--" + filename);
            // var fileData = new FormData();
            $.ajax({
                url: '/Home/ImportExcelFile/' + conn + '/' + userid + '/' + throttlenum + '/' + throttleduration + '/' + rtu + '/' + filename,

                //dataType: 'JSON',
                type: "POST",
                contentType: false, // Not to set any content header
                processData: false, // Not to process data

                async: true,
                beforeSend: function () {
                    $("#UploadBtn").attr('disabled', 'disabled');
                    $("#progress").css("display", "block");
                },
                progress: function (result) {
                    var percentage = 0;
                    console('amithere');
                    var timer = setInterval(() => {
                        percentage = percentage + 2;
                        progress_bar_process(percentage, timer);
                    }, 3000);
                    console.log("running....");
                },
                success: function (result) {
                    console.log(result);
                    document.getElementById('spin').style.visibility = "hidden";
                    document.getElementById('UploadBtn').value = 'Run CONFIG IMPORT   ';
                    document.getElementById("divAlert").children[0].innerHTML = "File Import DONE";
                    $('#UploadBtn').prop("disabled", "disabled");
                    document.getElementById("file1").value = null;
                    if (result != "") {
                        LoadProgressBar(); //calling LoadProgressBar function to load the progress bar.
                    }
                },
                xhr: function () {
                    // get the native XmlHttpRequest object
                    var xhr = $.ajaxSettings.xhr();
                    $("#uu .progress-bar").css("width", 9 + "%");
                    LoadProgressBar();
                    console.log('xhr start');
                    var percentage = 0;
                    var timer = setInterval(() => {
                        percentage = percentage + 9;
                        progress_bar_process(percentage, timer);
                    }, 1800);
                    xhr.onprogress = function (evt) {
                        console.log('in progress- main area!');
                        LoadProgressBar();
                        if (evt.lengthComputable) { // it always is false
                            console.log(evt.loaded + " " + evt.total + " " + evt.currentTarget.LOADING + " " + evt.currentTarget.DONE)
                            var res = evt.loaded / evt.currentTarget.DONE * 100;
                            console.log('progress', res);
                            $("#uu .progress-bar").css("width", res + "%").text(res + "%");
                        }
                    };
                    // set the onload event handler
                    xhr.onload = function () { console.log('DONE!') };
                    // return the customized object
                    return xhr;
                },
                error: function (err) { alert(err.statusText); }
            });

        });

        function progress_bar_process(percentage, timer) {
            $(".progress-bar").css("width", percentage + '%');
            if (percentage > 100) {
                clearInterval(timer);
                $("#progress").css("display", "none");
                $(".progress-bar").css("width", "0%");
                $("#UploadBtn").attr('disabled', false);

            }
        }

        function LoadProgressBar() {
            var progressbar = $("#prog");
            progressbar.show();
            $("#prog").progressbar({
                value: false,
                change: function () {
                    var progval = progressbar.progressbar("value") + "%";
                    console.log(progval);
                    //  progressLabel.text(progval);  // Showing the progress increment value in progress bar
                },
                complete: function () {
                    progressbar.hide();
                }
            });
            function progress() {
                var val = progressbar.progressbar("value") || 0;
                progressbar.progressbar("value", val + 1);
                console.log("inside the fuction progress");
                if (val < 99) {
                    setTimeout(progress, 100);
                    console.log('trying to slow down ..');
                }
            }
            setTimeout(progress, 1000);
        }
    </script>
}
